<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kmbeast.mapper.PetMapper">

    <insert id="save">
        INSERT INTO pet (id, name, cover, detail, address, age, gender, pet_type_id, is_vaccine, is_recommend, is_adopt,
        create_time)
        VALUES (#{id}, #{name}, #{cover}, #{detail}, #{address}, #{age}, #{gender}, #{petTypeId}, #{isVaccine}, #{isRecommend},
        #{isAdopt}, #{createTime})
    </insert>

    <update id="update">
        UPDATE pet
        <set>
            <if test="name != null and name != ''">name = #{name},</if>
            <if test="cover != null and cover != ''">cover = #{cover},</if>
            <if test="detail != null and detail != ''">detail = #{detail},</if>
            <if test="address != null and address != ''">address = #{address},</if>
            <if test="age != null">age = #{age},</if>
            <if test="gender != null">gender = #{gender},</if>
            <if test="petTypeId != null">pet_type_id = #{petTypeId},</if>
            <if test="isVaccine != null">is_vaccine = #{isVaccine},</if>
            <if test="isRecommend != null">is_recommend = #{isRecommend},</if>
            <if test="isAdopt != null">is_adopt = #{isAdopt},</if>
        </set>
        WHERE id = #{id}
    </update>

    <update id="updateById">
        UPDATE pet
        <set>
            <if test="et.isAdopt != null">is_adopt = #{et.isAdopt}</if>
        </set>
        WHERE id = #{et.id}
    </update>

    <delete id="deleteById">
        DELETE FROM pet WHERE id = #{id}
    </delete>


    <!-- 查询单个宠物信息（新增统计字段） -->
    <select id="getById" resultMap="BaseResultMap">
        SELECT
        p.id,
        p.name,
        p.cover,
        p.detail,
        p.address,
        p.age,
        p.gender,
        p.pet_type_id,
        p.is_vaccine,
        p.is_recommend,
        p.is_adopt,
        p.create_time,
        pt.name AS pet_type_name,
        -- 点赞量：统计active_net中type=2（点赞）、contentType=PET的数据
        (SELECT COUNT(*)
        FROM active_net an
        WHERE an.content_id = p.id
        AND an.content_type = 'PET'
        AND an.type = 2) AS upvote_number,
        -- 浏览量：统计active_net中type=1（浏览）、contentType=PET的数据
        (SELECT COUNT(*)
        FROM active_net an
        WHERE an.content_id = p.id
        AND an.content_type = 'PET'
        AND an.type = 1) AS view_number,
        -- 收藏量：统计active_net中type=3（收藏）、contentType=PET的数据
        (SELECT COUNT(*)
        FROM active_net an
        WHERE an.content_id = p.id
        AND an.content_type = 'PET'
        AND an.type = 3) AS save_number
        FROM pet p
        LEFT JOIN pet_type pt ON pt.id = p.pet_type_id
        WHERE p.id = #{id}
    </select>

    <select id="queryListItemByIds" resultMap="BaseResultItemMap">

        SELECT p.id,
        p.name,
        p.cover,
        p.address,
        p.age,
        p.gender,
        p.pet_type_id,
        p.is_vaccine,
        p.is_recommend,
        p.is_adopt,
        p.create_time,
        pt.name AS pet_type_name
        FROM pet p
        LEFT JOIN pet_type pt ON pt.id = p.pet_type_id
        WHERE p.id IN
        <foreach collection="ids" item="id" separator="," index="index" open="(" close=")">
            #{id}
        </foreach>

    </select>


    <select id="queryAllIds" resultType="java.lang.Integer">
        SELECT p.id
        FROM pet p
    </select>


    <!-- 查询宠物信息列表（新增统计字段） -->
    <select id="queryListItem" resultMap="BaseResultItemMap">
        SELECT
        p.id,
        p.name,
        p.cover,
        p.address,
        p.age,
        p.gender,
        p.pet_type_id,
        p.is_vaccine,
        p.is_recommend,
        p.is_adopt,
        p.create_time,
        pt.name AS pet_type_name,
        -- 列表中也可添加统计字段（按需选择）
        (SELECT COUNT(*)
        FROM active_net an
        WHERE an.content_id = p.id
        AND an.content_type = 'PET'
        AND an.type = 2) AS upvote_number,
        (SELECT COUNT(*)
        FROM active_net an
        WHERE an.content_id = p.id
        AND an.content_type = 'PET'
        AND an.type = 1) AS view_number,
        (SELECT COUNT(*)
        FROM active_net an
        WHERE an.content_id = p.id
        AND an.content_type = 'PET'
        AND an.type = 3) AS save_number
        FROM pet p
        LEFT JOIN pet_type pt ON pt.id = p.pet_type_id
        <where>
            <if test="name != null and name != ''">
                AND p.name LIKE concat('%',#{name},'%')
            </if>
            <if test="isRecommend != null ">
                AND p.is_recommend = #{isRecommend}
            </if>
            <if test="petTypeId != null ">
                AND p.pet_type_id = #{petTypeId}
            </if>
        </where>
        <if test="current != null and size != null">
            LIMIT #{current},#{size}
        </if>
    </select>


    <!-- 满足分页条件的数据总项 -->
    <select id="queryCount" resultType="integer">
        SELECT COUNT(*)
        FROM pet p
        <where>
            <if test="name != null and name != ''">
                AND p.name LIKE concat('%',#{name},'%')
            </if>
            <if test="isRecommend != null ">
                AND p.is_recommend = #{isRecommend}
            </if>
            <if test="petTypeId != null ">
                AND p.pet_type_id = #{petTypeId}
            </if>
        </where>
    </select>

    <select id="queryByName" resultMap="BaseResultMap">
        SELECT p.id, p.name
        FROM pet p
        WHERE p.name = #{name}
    </select>


    <!-- 通用查询映射结果（添加统计字段映射） -->
    <resultMap id="BaseResultItemMap" type="com.kmbeast.pojo.vo.PetListItemVO">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="cover" property="cover"/>
        <result column="address" property="address"/>
        <result column="age" property="age"/>
        <result column="gender" property="gender"/>
        <result column="pet_type_id" property="petTypeId"/>
        <result column="pet_type_name" property="petTypeName"/>
        <result column="is_vaccine" property="isVaccine"/>
        <result column="is_recommend" property="isRecommend"/>
        <result column="is_adopt" property="isAdopt"/>
        <result column="create_time" property="createTime"/>

    </resultMap>

    <resultMap id="BaseResultMap" type="com.kmbeast.pojo.vo.PetVO">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="cover" property="cover"/>
        <result column="detail" property="detail"/>
        <result column="address" property="address"/>
        <result column="age" property="age"/>
        <result column="gender" property="gender"/>
        <result column="pet_type_id" property="petTypeId"/>
        <result column="pet_type_name" property="petTypeName"/>
        <result column="is_vaccine" property="isVaccine"/>
        <result column="is_recommend" property="isRecommend"/>
        <result column="is_adopt" property="isAdopt"/>
        <result column="create_time" property="createTime"/>
        <!-- 新增统计字段映射 -->
        <result column="upvote_number" property="upvoteNumber"/>
        <result column="view_number" property="viewNumber"/>
        <result column="save_number" property="saveNumber"/>
    </resultMap>

</mapper>